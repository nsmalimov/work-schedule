import pytest

from timetable.db_worker.psql_worker import PSQLWorker
from timetable.scheduler.scheduler import Scheduler


# todo: через фикстуры и моки
async def get_pSQLWorker():
    pSQLWorker = PSQLWorker()

    await pSQLWorker.init_connect(
        user='postgres',
        password='123',
        database='timetable',
        host='localhost'
    )

    return pSQLWorker


@pytest.mark.asyncio
async def test_get_workers_with_tasks():
    pSQLWorker = await get_pSQLWorker()
    workers_with_tasks = await pSQLWorker.get_workers_with_tasks()

    # todo: more check
    assert len(workers_with_tasks) == 7


# todo: разделить на 2 теста
@pytest.mark.asyncio
async def test_get_full_free_slots_and_get_available_free_slots():
    pSQLWorker = await get_pSQLWorker()
    workers_with_tasks = await pSQLWorker.get_workers_with_tasks()

    scheduler = Scheduler(pSQLWorker)

    # test_cases_get_full_free_slots
    full_free_slots_by_workers = scheduler.get_full_free_slots(workers_with_tasks)

    test_cases_get_full_free_slots = {
        # work: 18:00:00 - 02:00:00
        # tasks: 20:00:00 - 00:00:00
        1: [
            '2000-01-01 18:00:00=2000-01-01 19:00:00',
            '2000-01-01 18:00:00=2000-01-01 20:00:00',
            '2000-01-01 19:00:00=2000-01-01 20:00:00',
            '2000-01-02 00:00:00=2000-01-02 01:00:00',
            '2000-01-02 00:00:00=2000-01-02 02:00:00',
            '2000-01-02 01:00:00=2000-01-02 02:00:00',
        ],
        # 10:00:00 - 22:00:00
        # tasks: 12:00:00 - 16:00:00, 16:00:00 - 18:00:00
        3: [
            '2000-01-01 10:00:00=2000-01-01 11:00:00',
            '2000-01-01 10:00:00=2000-01-01 12:00:00',
            '2000-01-01 11:00:00=2000-01-01 12:00:00',
            '2000-01-01 18:00:00=2000-01-01 19:00:00',
            '2000-01-01 18:00:00=2000-01-01 20:00:00',
            '2000-01-01 18:00:00=2000-01-01 21:00:00',
            '2000-01-01 18:00:00=2000-01-01 22:00:00',
            '2000-01-01 19:00:00=2000-01-01 20:00:00',
            '2000-01-01 19:00:00=2000-01-01 21:00:00',
            '2000-01-01 19:00:00=2000-01-01 22:00:00',
            '2000-01-01 20:00:00=2000-01-01 21:00:00',
            '2000-01-01 20:00:00=2000-01-01 22:00:00',
            '2000-01-01 21:00:00=2000-01-01 22:00:00',
        ],
        # 19:00:00 - 02:00:00
        # tasks: no
        4: ['2000-01-01 19:00:00=2000-01-01 20:00:00',
            '2000-01-01 19:00:00=2000-01-01 21:00:00',
            '2000-01-01 19:00:00=2000-01-01 22:00:00',
            '2000-01-01 19:00:00=2000-01-01 23:00:00',
            '2000-01-01 20:00:00=2000-01-01 21:00:00',
            '2000-01-01 20:00:00=2000-01-01 22:00:00',
            '2000-01-01 20:00:00=2000-01-01 23:00:00',
            '2000-01-01 20:00:00=2000-01-02 00:00:00',
            '2000-01-01 21:00:00=2000-01-01 22:00:00',
            '2000-01-01 21:00:00=2000-01-01 23:00:00',
            '2000-01-01 21:00:00=2000-01-02 00:00:00',
            '2000-01-01 21:00:00=2000-01-02 01:00:00',
            '2000-01-01 22:00:00=2000-01-01 23:00:00',
            '2000-01-01 22:00:00=2000-01-02 00:00:00',
            '2000-01-01 22:00:00=2000-01-02 01:00:00',
            '2000-01-01 22:00:00=2000-01-02 02:00:00',
            '2000-01-01 23:00:00=2000-01-02 00:00:00',
            '2000-01-01 23:00:00=2000-01-02 01:00:00',
            '2000-01-01 23:00:00=2000-01-02 02:00:00',
            '2000-01-02 00:00:00=2000-01-02 01:00:00',
            '2000-01-02 00:00:00=2000-01-02 02:00:00',
            '2000-01-02 01:00:00=2000-01-02 02:00:00']
    }

    assert list(full_free_slots_by_workers.keys()) == [1, 3, 6, 12, 10, 13, 4]

    for worker_id in full_free_slots_by_workers:
        current_case = []
        for free_slot in full_free_slots_by_workers[worker_id]:
            current_case.append(free_slot)

        if worker_id in test_cases_get_full_free_slots:
            assert current_case == test_cases_get_full_free_slots[worker_id]

    # todo: вынести в отдельный
    # test_get_available_free_slots
    test_cases_get_available_free_slots = ['2000-01-01 18:00:00=2000-01-01 19:00:00',
                                           '2000-01-01 18:00:00=2000-01-01 20:00:00',
                                           '2000-01-01 19:00:00=2000-01-01 20:00:00',
                                           '2000-01-02 00:00:00=2000-01-02 01:00:00',
                                           '2000-01-02 00:00:00=2000-01-02 02:00:00',
                                           '2000-01-02 01:00:00=2000-01-02 02:00:00',
                                           '2000-01-01 10:00:00=2000-01-01 11:00:00',
                                           '2000-01-01 10:00:00=2000-01-01 12:00:00',
                                           '2000-01-01 11:00:00=2000-01-01 12:00:00',
                                           '2000-01-01 18:00:00=2000-01-01 21:00:00',
                                           '2000-01-01 18:00:00=2000-01-01 22:00:00',
                                           '2000-01-01 19:00:00=2000-01-01 21:00:00',
                                           '2000-01-01 19:00:00=2000-01-01 22:00:00',
                                           '2000-01-01 20:00:00=2000-01-01 21:00:00',
                                           '2000-01-01 20:00:00=2000-01-01 22:00:00',
                                           '2000-01-01 21:00:00=2000-01-01 22:00:00',
                                           '2000-01-01 14:00:00=2000-01-01 15:00:00',
                                           '2000-01-01 14:00:00=2000-01-01 16:00:00',
                                           '2000-01-01 14:00:00=2000-01-01 17:00:00',
                                           '2000-01-01 14:00:00=2000-01-01 18:00:00',
                                           '2000-01-01 15:00:00=2000-01-01 16:00:00',
                                           '2000-01-01 15:00:00=2000-01-01 17:00:00',
                                           '2000-01-01 15:00:00=2000-01-01 18:00:00',
                                           '2000-01-01 16:00:00=2000-01-01 17:00:00',
                                           '2000-01-01 16:00:00=2000-01-01 18:00:00',
                                           '2000-01-01 17:00:00=2000-01-01 18:00:00',
                                           '2000-01-01 12:00:00=2000-01-01 13:00:00',
                                           '2000-01-01 12:00:00=2000-01-01 14:00:00',
                                           '2000-01-01 12:00:00=2000-01-01 15:00:00',
                                           '2000-01-01 12:00:00=2000-01-01 16:00:00',
                                           '2000-01-01 13:00:00=2000-01-01 14:00:00',
                                           '2000-01-01 13:00:00=2000-01-01 15:00:00',
                                           '2000-01-01 13:00:00=2000-01-01 16:00:00',
                                           '2000-01-01 13:00:00=2000-01-01 17:00:00',
                                           '2000-01-01 15:00:00=2000-01-01 19:00:00',
                                           '2000-01-01 16:00:00=2000-01-01 19:00:00',
                                           '2000-01-01 16:00:00=2000-01-01 20:00:00',
                                           '2000-01-01 17:00:00=2000-01-01 19:00:00',
                                           '2000-01-01 17:00:00=2000-01-01 20:00:00',
                                           '2000-01-01 17:00:00=2000-01-01 21:00:00',
                                           '2000-01-01 19:00:00=2000-01-01 23:00:00',
                                           '2000-01-01 20:00:00=2000-01-01 23:00:00',
                                           '2000-01-01 20:00:00=2000-01-02 00:00:00',
                                           '2000-01-01 21:00:00=2000-01-01 23:00:00',
                                           '2000-01-01 21:00:00=2000-01-02 00:00:00',
                                           '2000-01-01 22:00:00=2000-01-01 23:00:00',
                                           '2000-01-01 22:00:00=2000-01-02 00:00:00',
                                           '2000-01-01 23:00:00=2000-01-02 00:00:00',
                                           '2000-01-01 10:00:00=2000-01-01 13:00:00',
                                           '2000-01-01 10:00:00=2000-01-01 14:00:00',
                                           '2000-01-01 11:00:00=2000-01-01 13:00:00',
                                           '2000-01-01 11:00:00=2000-01-01 14:00:00',
                                           '2000-01-01 11:00:00=2000-01-01 15:00:00',
                                           '2000-01-01 21:00:00=2000-01-02 01:00:00',
                                           '2000-01-01 22:00:00=2000-01-02 01:00:00',
                                           '2000-01-01 22:00:00=2000-01-02 02:00:00',
                                           '2000-01-01 23:00:00=2000-01-02 01:00:00',
                                           '2000-01-01 23:00:00=2000-01-02 02:00:00']

    available_free_slots = await scheduler.get_available_free_slots(full_free_slots_by_workers)

    assert available_free_slots == test_cases_get_available_free_slots

    # todo: вынести в отдельный
    # test_create_objects_from_time_mask

    test_cases_create_objects_from_time_mask = ['18:00:00 19:00:00 1',
                                                '18:00:00 20:00:00 2',
                                                '19:00:00 20:00:00 1',
                                                '00:00:00 01:00:00 1',
                                                '00:00:00 02:00:00 2',
                                                '01:00:00 02:00:00 1',
                                                '10:00:00 11:00:00 1',
                                                '10:00:00 12:00:00 2',
                                                '11:00:00 12:00:00 1',
                                                '18:00:00 21:00:00 3',
                                                '18:00:00 22:00:00 4',
                                                '19:00:00 21:00:00 2',
                                                '19:00:00 22:00:00 3',
                                                '20:00:00 21:00:00 1',
                                                '20:00:00 22:00:00 2',
                                                '21:00:00 22:00:00 1',
                                                '14:00:00 15:00:00 1',
                                                '14:00:00 16:00:00 2',
                                                '14:00:00 17:00:00 3',
                                                '14:00:00 18:00:00 4',
                                                '15:00:00 16:00:00 1',
                                                '15:00:00 17:00:00 2',
                                                '15:00:00 18:00:00 3',
                                                '16:00:00 17:00:00 1',
                                                '16:00:00 18:00:00 2',
                                                '17:00:00 18:00:00 1',
                                                '12:00:00 13:00:00 1',
                                                '12:00:00 14:00:00 2',
                                                '12:00:00 15:00:00 3',
                                                '12:00:00 16:00:00 4',
                                                '13:00:00 14:00:00 1',
                                                '13:00:00 15:00:00 2',
                                                '13:00:00 16:00:00 3',
                                                '13:00:00 17:00:00 4',
                                                '15:00:00 19:00:00 4',
                                                '16:00:00 19:00:00 3',
                                                '16:00:00 20:00:00 4',
                                                '17:00:00 19:00:00 2',
                                                '17:00:00 20:00:00 3',
                                                '17:00:00 21:00:00 4',
                                                '19:00:00 23:00:00 4',
                                                '20:00:00 23:00:00 3',
                                                '20:00:00 00:00:00 4',
                                                '21:00:00 23:00:00 2',
                                                '21:00:00 00:00:00 3',
                                                '22:00:00 23:00:00 1',
                                                '22:00:00 00:00:00 2',
                                                '23:00:00 00:00:00 1',
                                                '10:00:00 13:00:00 3',
                                                '10:00:00 14:00:00 4',
                                                '11:00:00 13:00:00 2',
                                                '11:00:00 14:00:00 3',
                                                '11:00:00 15:00:00 4',
                                                '21:00:00 01:00:00 4',
                                                '22:00:00 01:00:00 3',
                                                '22:00:00 02:00:00 4',
                                                '23:00:00 01:00:00 2',
                                                '23:00:00 02:00:00 3']

    slots = scheduler.create_objects_from_time_mask(available_free_slots)

    # todo: лучше в обратную сторону (через объекты)
    res = []
    for slot in slots:
        res.append('{0} {1} {2}'.format(slot.time_start,
                                        slot.time_end,
                                        slot.duration))

    assert res == test_cases_create_objects_from_time_mask

# todo: test create_objects_from_time_mask and print_slots
